{% extends "base.html" %}

{% block title %}Attendance Records{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                    <h5 class="m-0 fw-bold text-primary"><i class="fas fa-clipboard-list me-2"></i>Attendance Records</h5>
                    <div>
                        <a href="{{ url_for('admin.export_csv', date=req_date) }}" class="btn btn-sm btn-success rounded-pill px-3 me-2"><i class="fas fa-file-csv me-1"></i> Export CSV</a>
                        <a href="{{ url_for('admin.dashboard') }}" class="btn btn-sm btn-outline-primary rounded-pill px-3"><i class="fas fa-arrow-left me-1"></i> Back</a>
                    </div>
                </div>
                <div class="card-body p-4">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <form method="get" class="d-flex">
                                <div class="input-group input-group-lg shadow-sm">
                                    <span class="input-group-text bg-light border-end-0"><i class="fas fa-calendar text-primary"></i></span>
                                    <input type="date" class="form-control bg-light border-start-0" name="date" value="{{ req_date }}" placeholder="YYYY-MM-DD">
                                    <button type="submit" class="btn btn-primary px-4">Filter</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    {% if records %}
                    <div class="table-responsive">
                        <table class="table table-hover" id="attendanceTable">
                            <thead>
                                <tr>
                                    <th class="fw-bold">ID</th>
                                    <th class="fw-bold">Name</th>
                                    <th class="fw-bold">Roll Number</th>
                                    <th class="fw-bold">Timestamp</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for a in records %}
                                <tr>
                                    <td>{{ a[0] }}</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <a href="#" data-bs-toggle="modal" data-bs-target="#studentPhotoModal{{ a[0] }}" class="me-3">
                                                <div class="avatar-sm bg-primary-soft rounded-circle d-flex align-items-center justify-content-center">
                                                    <span class="fw-bold text-primary">{{ a[1][:1] }}</span>
                                                </div>
                                            </a>
                                            <a href="{{ url_for('attendance.view_student', student_id=a[0]) }}" class="text-decoration-none text-dark">{{ a[1] }}</a>
                                        </div>
                                    </td>
                                    <td><span class="badge bg-light text-dark rounded-pill px-3 py-2">{{ a[2] }}</span></td>
                                    <td>
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div>
                                                <i class="fas fa-clock text-muted me-2"></i>
                                                {{ a[3] }}
                                            </div>
                                            <a href="{{ url_for('attendance.view_student', student_id=a[0]) }}" class="btn btn-sm btn-outline-primary rounded-pill">
                                                <i class="fas fa-eye me-1"></i> View
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info d-flex align-items-center">
                        <i class="fas fa-info-circle me-3 fs-4"></i>
                        <div>No attendance records found for the selected date.</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Student Photo Modals -->
{% for a in records %}
<div class="modal fade" id="studentPhotoModal{{ a[0] }}" tabindex="-1" aria-labelledby="studentPhotoModalLabel{{ a[0] }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold" id="studentPhotoModalLabel{{ a[0] }}">{{ a[1] }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center py-4">
                <div class="student-photo-container mx-auto mb-3" style="max-width: 300px;">
                    <div id="studentPhotoContent{{ a[0] }}" class="position-relative">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                <h5 class="mb-2">{{ a[1] }}</h5>
                <p class="text-muted mb-0">Roll Number: {{ a[2] }}</p>
            </div>
            <div class="modal-footer border-0">
                <a href="{{ url_for('attendance.view_student', student_id=a[0]) }}" class="btn btn-primary rounded-pill px-4">
                    <i class="fas fa-user me-1"></i> View Full Profile
                </a>
                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        $('#attendanceTable').DataTable({
            "pageLength": 10,
            "responsive": true,
            "order": [[3, 'desc']], // Sort by timestamp (descending)
            "language": {
                "search": "<i class='fas fa-search'></i> Search:",
                "paginate": {
                    "previous": "<i class='fas fa-chevron-left'></i>",
                    "next": "<i class='fas fa-chevron-right'></i>"
                }
            },
            "dom": '<"row"<"col-md-6"l><"col-md-6"f>><"table-responsive"t><"row"<"col-md-6"i><"col-md-6"p>>',
            "drawCallback": function() {
                $('.dataTables_paginate > .pagination').addClass('pagination-sm');
                $('.dataTables_length select').addClass('form-select form-select-sm');
                $('.dataTables_filter input').addClass('form-control form-control-sm');
            }
        });
        
        // Load student photos when modals are opened
        {% for a in records %}
        $('#studentPhotoModal{{ a[0] }}').on('show.bs.modal', function () {
            const studentId = {{ a[0] }};
            const photoContainer = $('#studentPhotoContent{{ a[0] }}');
            
            // Try to load the student image
            $.ajax({
                url: '{{ url_for("attendance.serve_student_image", student_id=a[0]) }}',
                type: 'GET',
                success: function() {
                    // Image exists, display it
                    photoContainer.html(`
                        <div class="rounded overflow-hidden shadow-sm border border-3 border-white" style="max-height: 300px;">
                            <img src="{{ url_for('attendance.serve_student_image', student_id=a[0]) }}" 
                                alt="{{ a[1] }}" 
                                class="img-fluid w-100 object-fit-cover">
                        </div>
                    `);
                },
                error: function() {
                    // Image doesn't exist, show placeholder
                    photoContainer.html(`
                        <div class="bg-primary-soft rounded d-flex align-items-center justify-content-center mx-auto shadow-sm border border-3 border-white" style="height: 300px;">
                            <i class="fas fa-user fa-5x text-primary"></i>
                        </div>
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle me-2"></i>
                            No photo available for this student
                        </div>
                    `);
                }
            });
        });
        {% endfor %}
    });
</script>
{% endblock %}
